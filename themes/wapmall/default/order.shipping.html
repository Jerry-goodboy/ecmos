
<div class="address">
	<div class="title w1150 mb10" style="margin: 10px;">
		<b class="fs14">{$lang.consignee_address}</b> <a
			href="{url app=my_address}" target="_blank">[{$lang.manage_address}]</a>
	</div>
	<script type="text/javascript" src="{lib file=mlselection.js}"
		charset="utf-8"></script>
	<script type="text/javascript"
		src="{lib file=jquery.plugins/jquery.validate.js}" charset="utf-8"></script>
	<script type="text/javascript" src="{lib file=dialog/dialog.js}"
		id="dialog_js" charset="utf-8"></script>
	<script type="text/javascript" src="{lib file=jquery.ui/jquery.ui.js}"
		id="dialog_js" charset="utf-8"></script>

	<script type="text/javascript">
	var shippings = {$shippings};
	var addresses = {$addresses};
	var order_amount=0;
	
	$(function() {
		regionInit("region");
		set_amount();
		
		$('li[shipping_id]').click(function(event) {
			var store_id=$(this).attr('store_id');
			var this_radio=$(this).find('input[name="shipping_id['+store_id+']"]');
			this_radio.prop('checked',true);
			set_amount();
			});
		});
	
	function set_amount(){
		var _amount = 0;
		var shipping_fee = 0;
		$('.store').each(function() {
			var store_id = this.id;
			var amount_store = $(this).find('#amount_'+store_id).attr('amount');

			/* $('ul[shipping_id]').each(function() {
				var this_radio=$(this).find('input[name="shipping_id['+store_id+']"]');
				if (this_radio.prop("checked")==true) {
					shipping_fee = this_radio.attr('shipping_fee');
				}
			}); */
			
			$('li[shipping_id]').each(function() {
				var this_radio=$(this).find('input[name="shipping_id['+store_id+']"]');
				if (this_radio.prop("checked") == true) {
					shipping_fee = this_radio.attr('shipping_fee');
				}
			});
			
			var _amount_store  = Number(amount_store) + Number(shipping_fee);
			$('#amount_'+store_id).html(price_format(_amount_store));
			
			_amount += Number(_amount_store);
			
		});
		
		order_amount = _amount;
		
		$('#order_amount').html(price_format(_amount));
	}
	
	function check_phone(){
		return ($('#phone_tel').val() == '' && $('#phone_mob').val() == '');
	}
	
	function hide_error(){
		$('#region').find('.error').hide();
	}
	
	</script>

	<!--{if $my_address}-->
	<script type="text/javascript">
	//<![CDATA[
	$(function(){
		
		$('.address_item').click(function(){
			$(this).find("input[name='address_options']").prop('checked', true);
			$('.address_item').removeClass('address-on');
			$(this).addClass('address-on');
			set_address();
		});
		
		set_address();
	});
	
	function set_address(){
	        
	    var addr_id = $("input[name='address_options']:checked").val();
	    if(addr_id == 0)
	    {
	        $('#consignee').val("");
	        $('#region_name').val("");
	        $('#region_id').val("");
	        $('#region select').show();
	        $("#edit_region_button").hide();
	        $('#region_name_span').hide();
	
	        $('#address').val("");
	        $('#zipcode').val("");
	        $('#phone_tel').val("");
	        $('#phone_mob').val("");
	        $('#popup').show();
	        $('#s-address').html("");
	        $('#s-name').html("");
	        
	        $('#address_form').css('display', 'block');
	    }
	    else
	    {
	        $('#popup').hide();
	        fill_address_form(addr_id);
	        
	        $('#address_form').css('display', 'none');
	    }
	}

	function fill_address_form(addr_id){
	    var addr_data = addresses[addr_id];
	    var html_address;
	    var html_name;
	    html_address=addr_data['region_name']+" "+addr_data['address'];
	    html_name=addr_data['phone_tel']?addr_data['consignee']+" "+addr_data['phone_tel']:addr_data['consignee']+" "+addr_data['phone_mob'];
	    
	    for(k in addr_data){
	        switch(k){
	            case 'consignee':
	            case 'address':
	            case 'zipcode':
	            case 'email':
	            case 'phone_tel':
	            case 'phone_mob':
	            case 'region_id':
	                $("input[name='" + k + "']").val(addr_data[k]);
	            break;
	            case 'region_name':
	                $("input[name='" + k + "']").val(addr_data[k]);
	                $('#region select').hide();
	                $('#region_name_span').text(addr_data[k]).show();
	                $("#edit_region_button").show();
	            break;
	        }
	    }
	    $('#s-address').html(html_address);
	    $('#s-name').html(html_name);
	}
	//]]>
	</script>

	<!---------收货地址---------->
	<!--{foreach from=$my_address item=address name=address_select}-->
	<div
		class="address_info address_item{if $smarty.foreach.address_select.iteration == 1} selected_address{/if}">
		<a href="javascript:void(0);"> <input type="radio" class="radio"
			{if $smarty.foreach.address_select.iteration == 1}
			checked="true"
			{/if}
			name="address_options" value="{$address.addr_id}"
			id="address_{$address.addr_id}" />
			<span>收货人:{$address.consignee|escape}（<!--{if $address.phone_mob}-->{$address.phone_mob}<!--{else}-->{$address.phone_tel}<!--{/if}-->）</span>
			<br />
			<span class="dt">{$address.region_name|escape}&nbsp;&nbsp;{$address.address|escape}</span>
			<b>></b>
		</a>
	</div>
	<!--{/foreach}-->
	<div class="address_info new address_item">
		<p><input id="use_new_address" type="radio" value="0" class="radio" name="address_options" />使用新的收货地址</p>
	</div>
	<!--{/if}-->

	<!-- 使用新地址 -->
	<div id="address_form" class="add_box" style="margin: -4px 10px 0; padding: 5px 0 0 15px; background: #fff; border: #aaa solid 1px; border-top: none; border-radius: 0 0 5px 5px; position: relative; display: none;">
		<p>
			<span class="field_message explain">收货人姓名:</span><input
				placeholder="请填写你的收货人姓名" type="text" name="consignee" id="consignee" />
		</p>
		<p>
			<span class="field_message explain">手机号码:</span><input type="text"
				name="phone_mob" id="phone_mob" placeholder="请填写你的手机号码" />
		</p>
		<p>
			<span class="field_message explain">电话号码:</span><input type="text"
				name="phone_tel" id="phone_tel" placeholder="请填写你的电话号码" />
		</p>
		<p id="region">
			<span class="field_message explain">地区:</span> <span
				style="display: none;" id="region_name_span"></span> <input
				id="edit_region_button" type="button" class="edit_region"
				value="{$lang.edit}" style="display: none;" /> <select
				onchange="hide_error();">
				<option value="0">--请选择地区--</option> {html_options options=$regions}
			</select> <input type="hidden" class="mls_id" name="region_id" id="region_id" />
			<input type="hidden" name="region_name" class="mls_names"
				id="region_name" /> <span class="field_message "></span>

		</p>
		<p>
			<span class="field_message explain">详细地址:</span> <input type="text"
				name="address" id="address" placeholder="详细地址,不必重复填写地区" />
		</p>
		<p>
			<span class="field_message explain">邮政编码:</span><input type="text"
				name="zipcode" id="zipcode" placeholder="请填写邮政编码" />
		</p>
		<!--  -->
		<p>
			<input type="checkbox" value="1" id="save_address" name="save_address" class="mr" />自动保存收货地址
		</p>
	</div>

</div>

<!---------收货地址结束---------->

<style>
.dialog_wrapper {
	width: 80%;
}

#region select {
	margin-top: 10px;
}
</style>