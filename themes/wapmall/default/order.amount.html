
<script type="text/javascript">
$(function(){ 
  $('#use_coupon').click(function(event) {
    $(this).parent('p').next().toggle();
    $('#coupon_sn').val('');
    $('#my_coupon').val(0);
    if ($(this).val()=='{$lang.use_coupon}') {

      $(this).val('{$lang.close_coupon}'); 
    }else{
      $(this).val('{$lang.use_coupon}'); 
    }
    compute_amount();
  });
   $('#check_coupon').click(function(){
       var coupon_sn = $('#coupon_sn').val();
       if(coupon_sn == '')
       {
           return;
       }
       $.getJSON("index.php?app=order&act=check_coupon", {coupon_sn: coupon_sn, store_id: '{$smarty.get.store_id}'}, function(data){
           if(data['retval'])
           {
               $('.unusable').hide();
               var msg = '{$lang.usable}';
               var str = price_format(data['retval']['price']);
               $('.usable').show().html(msg + str).css("display","block");
               $('#my_coupon').val(data['retval']['price']);
           }
           else
           {
               $('.usable').hide();
               $('.unusable').show().css("display","block");
               $('#coupon_sn').val('');
               $('#my_coupon').val(0);
           }
           compute_amount();
       });
   });
  $('#use_money').click(function(){
    $(this).parent('p').next().toggle();
    //$(this).hide();
    var my_money={$my_money.money|default:0};
    var my_coupon= $('#my_coupon').val();
    my_coupon=parseFloat(my_coupon);
    my_money=parseFloat(my_money);
    var _amount=order_amount-my_coupon;
    var min=my_money<_amount ? my_money :_amount;
      min=deal(min);
    //alert(min);
    if($(this).val()=='{$lang.use_money}'){
      $('#submit').hide();
      $('#my_money').val(min);
      $(this).val('{$lang.close_money}');     
    }else{
      $('#submit').show();
      $('#my_money').val(0);
      $(this).val('{$lang.use_money}')
    }
    compute_amount();

  }); 
  $('#my_money').blur(function(event) {
    var my_money_can=$('#my_money').val();
    var my_money={$my_money.money|default:0};
    if (my_money_can>my_money) {

      $(this).val(0);
      alert('{$lang.my_money_cannot}');

    }else{
      my_money_can=deal(my_money_can);
      $(this).val(my_money_can);
   
      compute_amount();
    }

  });

  $('#submit').click(function(event) {
      
      compute_amount();
  });
  
    $('#use_password').click(function(event) {
      var password=$('#password').val();
      $.getJSON('/index.php?app=member&act=valid_pwd&password='+ password, 
        function(data) {  
          if(data)
          {
            $('#submit').show();
          }else{
            $('#submit').hide();
            alert('密码错误，请重输入');
          }
      });
    });

  function compute_amount()
  {
    var my_money= $('#my_money').val();
    var my_coupon= $('#my_coupon').val();
    my_money=parseFloat(my_money);
    my_coupon=parseFloat(my_coupon);
    var _amount=order_amount-my_money-my_coupon;
    if(_amount<0)
    {
      _amount=0;
    }
    _amount=_amount.toFixed(2);
     $('#order_amount').html(price_format(_amount));
  }

  function deal(number){
    number=parseFloat(number);
    number=number*100;
    number=Math.round(number);
    number=number/100;
    return number;
  }
});
</script>
<style>  
  .zf_password-button{margin-top: 5px;padding: 5px 5%;height: 30px;float: right;border: 1px solid #ddd;font-weight:bold;color: #BD0000;font-size: 14px;background-color: #f0f0f0;}
  .btn-allow-coupon{border: 1px solid #ddd;}
  .usable{margin-left: -1;display: none;}
  .unusable{margin-left: -1;display: none;}
</style>

<link href="{res file=css/main.css}" type="text/css" rel="stylesheet" />
<link href="{res file=css/global.css}" type="text/css" rel="stylesheet" />

<div class="w1150 price-promotion mt10 mb10 f60">
  <p class="mb10 mt10">
    {if $goods_info.allow_coupon}
    <input id="use_coupon" type="button" class="btn-allow-coupon center" value="{$lang.use_coupon}" />
    {/if}
  </p>
  {if $goods_info.allow_coupon}
  <p class="allow-coupon border padding10 mb10 hidden clearfix">
    {$lang.coupon_sn}:&nbsp;
    <input name="coupon_sn" id="coupon_sn" class='new_input' value="0" type="text" style="width: 50%;">
    <input type="hidden" name="my_coupon" id="my_coupon" value='0' />
    <input type="button" value="{$lang.check}" class="zf_password-button" id="check_coupon" style="margin-left: 28px;" />
    <span class="usable">{$lang.usable}</span> 
    <span class="unusable">{$lang.unusable}</span>
  </p>
  {/if}
</div>

<div class="w1150 price-promotion mt10 mb10 f60">
  <p class="mb10 mt10">
    <input id="use_money" type="button" class="btn-allow-coupon center" value="{$lang.use_money}" />
  </p>
  <p class="allow-coupon border padding10 mb10 hidden clearfix" style="text-align:left;">
    {$lang.my_money_note}{$lang.colon}
    <input name="my_money" id="my_money"  class='new_input' value="0" type="text">账户总额：{$my_money.money|price}
    <span class='my_money_note' style="color: #BD0000;"></span>
    <span><br /></span>
    <span><br /></span>
    <b style="{if $my_money.zf_pass}display:none;{/if}">
          <font color="red">{$lang.jinggao_set_zf_pass}</font><br />
          <a href="{url index.php?app=my_money&act=setting}" target="_blank">{$lang.set_zf_pass}</a>
          &nbsp; &nbsp; &nbsp; &nbsp;
      <span class="epay_btn">
          <a href="javascript:history.go(0);" target="_blank">设置成功后请刷新页面</a>
      </span>
    </b>
    
    <b style="{if !$my_money.zf_pass}display:none;{/if}">
      {$lang.use_password_now}
      <input name="password" id="password"  class='new_input' type="password"><br />
      <input id="use_password" type="button" class="zf_password-button" value="{$lang.use_password}" />
    </b>
  </p>

</div>
<div class="make_sure w1150 mb10" style="padding: 5px 3%;">
  <p style="height: 40px;">
    <span style="float: left;">
    <a href="{url app=cart&store_id=$goods_info.store_id}" class="back">{$lang.backto_cart}</a>
    </span><strong id="order_amount" style="float: right;">{$goods_info.amount|price}</strong>
    <span style="float: right; line-height: 30px;">{$lang.order_amount}{$lang.colon}</span>
    </p><p>
    <span>
      <a href="javascript:void($('#order_form').submit());" id="submit" class="submit_btn btn-step fff center strong fs14 ml20" style="margin: 0;">{$lang.shopping_step_three}</a>
    </span>
  </p>
</div>
<div class="w1150 price-notice mt10 mb10 pt10 f60 pb10">{$lang.price_notice}</div>